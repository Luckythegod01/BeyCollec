<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ma collection Beyblade X</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html {
      transition: background-color 0.4s ease, color 0.4s ease;
    }
    body, input, select, textarea, button {
      transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
    }
    body {
      font-family: 'Montserrat', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100" id="body">
  <div class="container mx-auto p-4">
    <div class="flex justify-end items-center gap-2 mb-4">
      <span id="userName" class="text-sm"></span>
      <button id="authBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Se connecter</button>
      <button id="themeToggle" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Th√®me clair</button>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center">Ma collection Beyblade X</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
      <input id="code" placeholder="Code produit" class="p-2 border rounded bg-gray-800 border-gray-700 text-white" />
      <input id="name" placeholder="Nom" class="p-2 border rounded bg-gray-800 border-gray-700 text-white" />
      <select id="type" class="p-2 border rounded bg-gray-800 border-gray-700 text-white">
        <option value="">Type de toupie</option>
        <option>Attack</option>
        <option>Defense</option>
        <option>Stamina</option>
        <option>Balance</option>
      </select>
      <input id="quantity" type="number" min="1" value="1" placeholder="Quantit√©" class="p-2 border rounded bg-gray-800 border-gray-700 text-white" />
      <input id="image" placeholder="URL de l'image" class="p-2 border rounded bg-gray-800 border-gray-700 text-white col-span-2" />
      <button id="addBtn" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 col-span-2">‚ûï Ajouter / Modifier</button>
    </div>

    <div class="flex flex-wrap gap-4 mb-6 items-center">
      <select id="filterType" class="p-2 border rounded bg-gray-800 border-gray-700 text-white">
        <option value="All">Tous les types</option>
        <option>Attack</option>
        <option>Defense</option>
        <option>Stamina</option>
        <option>Balance</option>
      </select>
      <input id="search" placeholder="Rechercher..." class="p-2 border rounded bg-gray-800 border-gray-700 text-white" />
      <button id="toggleSort" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700">üîÑ Trier</button>
    </div>

    <div id="collection" class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));"></div>
  </div>

  <script type="module">
    window.addEventListener("DOMContentLoaded", async () => {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js");
      const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js");
      const { getFirestore, doc, setDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "AIzaSyA0my0esYTJZ6ifuCKGsbKFKDqpohA1DQw",
        authDomain: "beycollec.firebaseapp.com",
        projectId: "beycollec",
        storageBucket: "beycollec.firebasestorage.app",
        messagingSenderId: "884713868558",
        appId: "1:884713868558:web:cd4e3d0fcc3506ea719b5f",
        measurementId: "G-K8SXMSHLYW"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const provider = new GoogleAuthProvider();
      const db = getFirestore();

      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", () => {
        const html = document.documentElement;
        const isDark = html.classList.toggle("dark");
        document.getElementById("body").className = isDark ? "bg-gray-900 text-gray-100" : "bg-white text-black";
        themeToggle.textContent = isDark ? "Th√®me clair" : "Th√®me sombre";

        document.querySelectorAll("input, select, textarea").forEach(el => {
          if (isDark) {
            el.classList.add("bg-gray-800", "text-white");
            el.classList.remove("bg-white", "text-black");
          } else {
            el.classList.remove("bg-gray-800", "text-white");
            el.classList.add("bg-white", "text-black");
          }
        });
        render();
      });

      let currentUser = null;
      let collection = [];
      let editCode = null;
      let sortByQuantity = false;

      const authBtn = document.getElementById("authBtn");
      const userNameDisplay = document.getElementById("userName");

      authBtn.addEventListener("click", async () => {
        if (auth.currentUser) {
          await signOut(auth);
        } else {
          await signInWithPopup(auth, provider);
        }
      });

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          userNameDisplay.textContent = user.displayName || "";
          authBtn.textContent = "Se d√©connecter";
          await loadCollection();
        } else {
          currentUser = null;
          userNameDisplay.textContent = "";
          authBtn.textContent = "Se connecter";
          collection = [];
          render();
        }
      });

      async function loadCollection() {
        if (!currentUser) return;
        const docRef = doc(db, "collections", currentUser.uid);
        const docSnap = await getDoc(docRef);
        collection = docSnap.exists() ? docSnap.data().items || [] : [];
        render();
      }

      async function saveCollection() {
        if (!currentUser) return;
        await setDoc(doc(db, "collections", currentUser.uid), { items: collection });
      }

      function render() {
        const list = document.getElementById("collection");
        list.innerHTML = "";
        const filterType = document.getElementById("filterType").value;
        const search = document.getElementById("search").value.toLowerCase();

        let items = collection.filter(item =>
          (filterType === "All" || item.type === filterType) &&
          (item.name.toLowerCase().includes(search) || item.code.toLowerCase().includes(search))
        );

        items.sort((a, b) => {
          if (sortByQuantity) return b.quantity - a.quantity;
          return a.name.localeCompare(b.name);
        });

        for (const item of items) {
          const div = document.createElement("div");
          const isDark = document.documentElement.classList.contains("dark");
          const badgeColor = {
            Attack: "red-500",
            Defense: "blue-500",
            Stamina: "green-500",
            Balance: "yellow-500"
          }[item.type] || "gray-500";

          div.className = `rounded-2xl shadow-lg p-4 text-xs transform transition-transform duration-200 ease-in-out hover:scale-105 
            ${isDark ? "bg-gray-800 border border-gray-700" : "bg-white border border-gray-300"}`;

          div.innerHTML = `
            <div class="flex flex-col items-center text-center">
              ${item.image ? `<img src="${item.image}" class="w-28 h-28 object-contain mb-3 rounded" alt="${item.name}" />` : ""}
              <h3 class="font-semibold text-sm leading-tight mb-1">${item.name}</h3>
              <p class="text-sm mb-1 text-gray-400">${item.code}</p>
              <span class="text-white text-xs font-semibold px-2 py-1 rounded-full bg-${badgeColor} mb-2">${item.type}</span>
              <p class="text-base mb-4">Qt√© : <strong>${item.quantity}</strong></p>
              <div class="flex gap-2">
                <button onclick='editItem("${item.id}")' class="bg-yellow-500 text-white text-sm px-3 py-1.5 rounded hover:bg-yellow-600">‚úèÔ∏è</button>
                <button onclick='deleteItem("${item.id}")' class="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700">üóëÔ∏è</button>
              </div>
            </div>
          `;
          list.appendChild(div);
        }
      }

      document.getElementById("addBtn").onclick = async () => {
        const code = document.getElementById("code").value.trim();
        const name = document.getElementById("name").value.trim();
        const type = document.getElementById("type").value;
        const quantity = parseInt(document.getElementById("quantity").value);
        const image = document.getElementById("image").value.trim();

        if (!code || !name || !type || quantity < 1 || isNaN(quantity)) return;

        const newItem = {
          id: editCode || crypto.randomUUID(),
          code, name, type, quantity, image
        };

        if (editCode) {
          collection = collection.map(item => item.id === editCode ? newItem : item);
          editCode = null;
        } else {
          collection.push(newItem);
        }

        document.querySelectorAll("input, select").forEach(el => {
          if (el.id !== "type" && el.id !== "filterType") el.value = "";
        });
        document.getElementById("quantity").value = 1;
        await saveCollection();
        render();
      };

      window.editItem = (id) => {
        const item = collection.find(i => i.id === id);
        if (!item) return;
        editCode = item.id;
        document.getElementById("code").value = item.code;
        document.getElementById("name").value = item.name;
        document.getElementById("type").value = item.type;
        document.getElementById("quantity").value = item.quantity;
        document.getElementById("image").value = item.image;
      };

      window.deleteItem = async (id) => {
        collection = collection.filter(item => item.id !== id);
        await saveCollection();
        render();
      };

      document.getElementById("toggleSort").onclick = () => {
        sortByQuantity = !sortByQuantity;
        render();
      };

      ["filterType", "search"].forEach(id => {
        document.getElementById(id).oninput = render;
      });
    });
  </script>
</body>
</html>
